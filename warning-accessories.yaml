variables:
  check_battery: !input check_battery
  check_unknown: !input check_unknown
  battery_warning_level: !input battery_warning_level
  exclude: !input exclude
  non_critical_entities: ['update', 'firmware', 'sensor.update', 'sensor.firmware'] 
  items: >
    {% set devices = {} %}

    {% for state in states if state.state in ['unavailable'] or (check_unknown and state.state == 'unknown') %}
      {% set add_entity = true %}
      {% if area_id(state.entity_id) == None or area_name(state.entity_id)[0:1] == '_' %}
        {% set add_entity = false %}
      {% endif %}
      {% if exclude is defined %}
        {% if exclude.entity_id is defined and state.entity_id in exclude.entity_id %}
          {% set add_entity = false %}
        {% endif %}
        {% if exclude.area_id is defined and area_id(state.entity_id) in exclude.area_id %}
          {% set add_entity = false %}
        {% endif %}
      {% endif %}
      {% if state.entity_id.split('.')[0] in non_critical_entities or state.entity_id.split('.')[0] == 'button' %}
        {% set add_entity = false %}
      {% endif %}

      {% if add_entity == true %}
        {% set device_id = device_id(state.entity_id) %}
        {% set entity_info = {'entity_id': state.entity_id, 'entity_name': state_attr(state.entity_id, 'friendly_name') or state.name, 'state': state.state} %}

        {# Initialize the device object if not already created #}
        {% if device_id not in devices %}
          {% set devices = devices | merge({device_id: {'device_name': device_attr(state.entity_id, 'name'), 'friendly_name': device_attr(state.entity_id, 'name_by_user') or device_attr(state.entity_id, 'name'), 'area_id': area_id(state.entity_id), 'affected_entities': []}}) %}
        {% endif %}

        {# Add the entity information to the affected_entities list #}
        {% set devices[device_id]['affected_entities'] = devices[device_id]['affected_entities'] | list %}
        {% set devices[device_id]['affected_entities'] = devices[device_id]['affected_entities'] + [entity_info] %}
      {% endif %}
    {% endfor %}

    {# Check battery states if enabled #}
    {% if check_battery %}
      {% for state in states.binary_sensor | rejectattr('attributes.device_class', 'undefined') | selectattr('attributes.device_class', 'eq', 'battery') | selectattr('state', 'eq', 'on') %}
        {% set add_entity = true %}
        {% if area_id(state.entity_id) == None or area_name(state.entity_id)[0:1] == '_' %}
          {% set add_entity = false %}
        {% endif %}
        {% if exclude is defined %}
          {% if exclude.entity_id is defined and state.entity_id in exclude.entity_id %}
            {% set add_entity = false %}
          {% endif %}
          {% if exclude.area_id is defined and area_id(state.entity_id) in exclude.area_id %}
            {% set add_entity = false %}
          {% endif %}
        {% endif %}

        {% if add_entity == true %}
          {% set device_id = device_id(state.entity_id) %}
          {% set entity_info = {'entity_id': state.entity_id, 'entity_name': state_attr(state.entity_id, 'friendly_name') or state.name, 'state': 'low battery'} %}

          {# Initialize the device object if not already created #}
          {% if device_id not in devices %}
            {% set devices = devices | merge({device_id: {'device_name': device_attr(state.entity_id, 'name'), 'friendly_name': device_attr(state.entity_id, 'name_by_user') or device_attr(state.entity_id, 'name'), 'area_id': area_id(state.entity_id), 'affected_entities': []}}) %}
          {% endif %}

          {# Add the entity information to the affected_entities list #}
          {% set devices[device_id]['affected_entities'] = devices[device_id]['affected_entities'] | list %}
          {% set devices[device_id]['affected_entities'] = devices[device_id]['affected_entities'] + [entity_info] %}
        {% endif %}
      {% endfor %}

      {% for state in states.sensor | rejectattr('state', 'eq', 'unavailable') | rejectattr('attributes.device_class', 'undefined') | selectattr('attributes.device_class', 'eq', 'battery') %}
        {% set add_entity = true %}
        {% if area_id(state.entity_id) == None or area_name(state.entity_id)[0:1] == '_' %}
          {% set add_entity = false %}
        {% endif %}
        {% if exclude is defined %}
          {% if exclude.entity_id is defined and state.entity_id in exclude.entity_id %}
            {% set add_entity = false %}
          {% endif %}
          {% if exclude.area_id is defined and area_id(state.entity_id) in exclude.area_id %}
            {% set add_entity = false %}
          {% endif %}
        {% endif %}
        {% if (state.state | int(-1)) >= (battery_warning_level | int(0)) %}
          {% set add_entity = false %}
        {% endif %}

        {% if add_entity == true %}
          {% set device_id = device_id(state.entity_id) %}
          {% set entity_info = {'entity_id': state.entity_id, 'entity_name': state_attr(state.entity_id, 'friendly_name') or state.name, 'state': 'low battery'} %}

          {# Initialize the device object if not already created #}
          {% if device_id not in devices %}
            {% set devices = devices | merge({device_id: {'device_name': device_attr(state.entity_id, 'name'), 'friendly_name': device_attr(state.entity_id, 'name_by_user') or device_attr(state.entity_id, 'name'), 'area_id': area_id(state.entity_id), 'affected_entities': []}}) %}
          {% endif %}

          {# Add the entity information to the affected_entities list #}
          {% set devices[device_id]['affected_entities'] = devices[device_id]['affected_entities'] | list %}
          {% set devices[device_id]['affected_entities'] = devices[device_id]['affected_entities'] + [entity_info] %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {{ devices | tojson }}